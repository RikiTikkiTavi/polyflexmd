Bootstrap: docker
From: python:3.9


%setup
mkdir ${SINGULARITY_ROOTFS}/opt/pysetup


%files
./src /opt/pysetup
./pyproject.toml /opt/pysetup
./poetry.lock /opt/pysetup
./README.md /opt/pysetup


%environment
. /opt/pysetup/.venv/bin/activate

%post
POETRY_HOME=/opt/poetry
POETRY_VERSION=1.3.0
POETRY_NO_INTERACTION=1
POETRY_HOME="/opt/poetry"

curl -sSL https://install.python-poetry.org | POETRY_HOME=$POETRY_HOME python - --version $POETRY_VERSION

PATH="$POETRY_HOME/bin:${PATH}"

cd /opt/pysetup

poetry config virtualenvs.in-project true
poetry install

%apprun system_creator
exec python -m system_creator "$@"

%apprun system_creator
exec python -m system_creator "$@"
